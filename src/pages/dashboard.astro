---
// src/pages/dashboard.astro (No changes)
import Base from "../layout/Base.astro";
import { supabase } from "../lib/supabase";
import type { GuestbookEntry } from "../types";

const { email } = Astro.locals;

// Fetch data ONLY ONCE here
const { data, error } = (await supabase
  .from("guestbook")
  .select("name, message")
  .order("created_at", { ascending: false })) as { data: GuestbookEntry[], error: any };

  if (error) {
      console.log(error)
      return new Response('Error fetching data', { status: 500});
  }
---

<Base title="Dashboard">
  <section>
    <p>{email}</p>
    <p>This is a protected page.</p>
    <a href="/api/auth/signout">Sign out</a>
    {data && data.map(entry => (
        <div>
            <h3>{entry.name}</h3>
            <p>{entry.message}</p>
        </div>
    ))}
  </section>
</Base>